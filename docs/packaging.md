## Packaging images

kbld can be used to package all referenced container images into a single tarball so that they can be easily imported into a different registry. One use case when this becomes useful is working in constrained environments without access to the Internet.

To produce a tarball:

```bash
kbld -f /tmp/manifest > /tmp/resolved-manifest
kbld pkg -f /tmp/resolved-manifest --output /tmp/app1-images.tar
```

First kbld invocation resolves images to their digest form (which is required by `kbld pkg` command), and second invocation downloads and packs all container images into `/tmp/app1-images.tar`.

To import a tarball:

```bash
kbld unpkg -f /tmp/resolved-manifest --input /tmp/app1-images.tar --repository docker.io/dkalinin/app1
```

Images are imported under a single new repository `docker.io/dkalinin/app1`. **You are guaranteed that images are exactly same as they are referenced by the same digests in produced YAML configuration (though under a different repository name)**.

Even though `kbld unpkg` uses registry APIs directly, it relies on credentials stored in `~/.docker/config.json` by default which are generated by running `docker login` command.

Notes:

- Produced tarball does not have duplicate image layers, as they are named by their digest (see `tar tvf /tmp/app1-images.tar`).
- If digest reference points to an image index, all children (images and other image indexes) will be included in the export. Saving only a portion of contents would of course change the digest.
- Only Docker v2 and OCI images and indexes are supported. Docker v1 format is not supported, hence, not all images out there could be exported and only registries supporting v2 format can be used for imports.
- Images that once were in different repositories are imported into the same repository to make it easier to manage them in bulk.
